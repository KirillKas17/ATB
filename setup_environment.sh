#!/bin/bash

# ============================================================================
# ATB Trading System - Environment Setup Script
# ============================================================================
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ

set -e  # ÐŸÑ€ÐµÐºÑ€Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ

echo "ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ ATB Trading System..."

# ============================================================================
# 1. ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐÐ«Ð¥ Ð¢Ð Ð•Ð‘ÐžÐ’ÐÐÐ˜Ð™
# ============================================================================
echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ð¹..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Python
if ! command -v python3 &> /dev/null; then
    echo "âŒ Python 3 Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Python 3.8+ Ð¸ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ."
    exit 1
fi

PYTHON_VERSION=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
echo "âœ… Python $PYTHON_VERSION Ð½Ð°Ð¹Ð´ÐµÐ½"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° pip
if ! command -v pip3 &> /dev/null; then
    echo "âŒ pip3 Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ pip Ð¸ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ."
    exit 1
fi

echo "âœ… pip3 Ð½Ð°Ð¹Ð´ÐµÐ½"

# ============================================================================
# 2. Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ Ð—ÐÐ’Ð˜Ð¡Ð˜ÐœÐžÐ¡Ð¢Ð•Ð™
# ============================================================================
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (ÐµÑÐ»Ð¸ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾)
if python3 -m venv --help &> /dev/null; then
    echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
    if [ ! -d "venv" ]; then
        python3 -m venv venv
        echo "âœ… Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾"
    else
        echo "âœ… Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
    fi
    
    # ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
    source venv/bin/activate
    echo "âœ… Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾"
    
    # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð² Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ð¸
    pip install --upgrade pip
    pip install pandas numpy requests python-dotenv
else
    echo "âš ï¸  Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹ (Ð½Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ð°)"
    pip3 install --break-system-packages pandas numpy requests python-dotenv || {
        echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ:"
        echo "   sudo apt update && sudo apt install python3-pandas python3-numpy python3-requests"
        exit 1
    }
fi

echo "âœ… ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

# ============================================================================
# 3. ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð˜
# ============================================================================
echo "âš™ï¸  ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
if [ ! -f ".env" ]; then
    if [ -f "env.example" ]; then
        cp env.example .env
        echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½ .env Ñ„Ð°Ð¹Ð» Ð¸Ð· env.example"
        echo "âš ï¸  Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼!"
    else
        echo "âŒ Ð¤Ð°Ð¹Ð» env.example Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        exit 1
    fi
else
    echo "âœ… .env Ñ„Ð°Ð¹Ð» ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
mkdir -p logs
mkdir -p models
mkdir -p data/training
echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ñ‹ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸"

# ============================================================================
# 4. ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð¡Ð˜ÐÐ¢ÐÐšÐ¡Ð˜Ð¡Ð
# ============================================================================
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ° ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."

SYNTAX_ERRORS=0

# Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
FILES_TO_CHECK=(
    "main.py"
    "infrastructure/core/feature_engineering.py"
    "infrastructure/core/technical.py"
    "infrastructure/core/technical_analysis.py"
)

for file in "${FILES_TO_CHECK[@]}"; do
    if [ -f "$file" ]; then
        if python3 -m py_compile "$file" 2>/dev/null; then
            echo "âœ… $file - ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ OK"
        else
            echo "âŒ $file - ÐµÑÑ‚ÑŒ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸"
            SYNTAX_ERRORS=$((SYNTAX_ERRORS + 1))
        fi
    else
        echo "âš ï¸  $file - Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
    fi
done

# ============================================================================
# 5. Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð• Ð¡ÐšÐ Ð˜ÐŸÐ¢Ð Ð—ÐÐŸÐ£Ð¡ÐšÐ
# ============================================================================
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°..."

cat > run_trading_system.sh << 'EOF'
#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº ATB Trading System..."

# ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (ÐµÑÐ»Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚)
if [ -d "venv" ]; then
    source venv/bin/activate
    echo "âœ… Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾"
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° .env Ñ„Ð°Ð¹Ð»Ð°
if [ ! -f ".env" ]; then
    echo "âŒ .env Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½! Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ setup_environment.sh"
    exit 1
fi

# Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
echo "ðŸ”„ Ð—Ð°Ð¿ÑƒÑÐº Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
python3 main.py

EOF

chmod +x run_trading_system.sh
echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°: run_trading_system.sh"

# ============================================================================
# 6. Ð¤Ð˜ÐÐÐ›Ð¬ÐÐÐ¯ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ
# ============================================================================
echo "ðŸŽ¯ Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸..."

if [ $SYNTAX_ERRORS -eq 0 ]; then
    echo "âœ… Ð’ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
    echo ""
    echo "ðŸ“‹ Ð¡Ð›Ð•Ð”Ð£Ð®Ð©Ð˜Ð• Ð¨ÐÐ“Ð˜:"
    echo "1. ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ñ Ð²Ð°ÑˆÐ¸Ð¼Ð¸ API ÐºÐ»ÑŽÑ‡Ð°Ð¼Ð¸"
    echo "2. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ PostgreSQL Ð¸ Redis (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)"
    echo "3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: ./run_trading_system.sh"
    echo ""
    echo "âš ï¸  Ð’ÐÐ–ÐÐž: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ API ÐºÐ»ÑŽÑ‡Ð¸ Ð´Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð°!"
else
    echo "âŒ ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ $SYNTAX_ERRORS ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº"
    echo "ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹"
    exit 1
fi

echo "ðŸŽ‰ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"